#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Script para reorganizar os produtos cartográficos por ano/tipo/escala.
Lê os GeoJSON existentes e cria novos arquivos mesclados.
"""

import json
import os
from collections import defaultdict
from pathlib import Path

# Diretório base
BASE_DIR = Path(__file__).parent.parent
DATA_DIR = BASE_DIR / "data"
OUTPUT_DIR = BASE_DIR / "data_reorganizado"

ARQUIVOS_IGNORADOS = [
    "situacao-geral-ct-25k",
    "situacao-geral-ct-50k",
    "situacao-geral-ct-100k",
    "situacao-geral-ct-250k"
]


LOTES = [
    # 2025
    ("bloco_1a_2025", "2025", "CT", "25k"),
    ("bloco_1b_2025", "2025", "CT", "25k"),
    ("bloco_1c_2025", "2025", "CT", "25k"),
    ("bloco_1d_2025", "2025", "CT", "25k"),
    ("bloco_1e_2025", "2025", "CT", "50k"),
    ("bloco_1f_2025", "2025", "CT", "50k"),
    ("bloco_1g_2025", "2025", "CT", "50k"),
    ("bloco_1k_2025", "2025", "CT", "50k"),
    ("bloco_1l_2025", "2025", "CT", "50k"),
    ("bloco_1m_2025", "2025", "CT", "25k"),
    ("bloco_1n_2025", "2025", "CO", "25k"),
    ("bloco_1o_2025", "2025", "CO", "50k"),
    ("bloco_1p_2025", "2025", "CO", "100k"),
    ("bloco_1q_2025", "2025", "CO", "25k"),

    # 2024
    ("ct_ci_125000", "2024", "CT", "25k"),
    ("demanda_cmo", "2024", "CT", "50k"),
    ("co_cimh", "2024", "CO", "50k"),
    ("poa_metropolitana", "2024", "CO", "25k"),
    ("ci_co_125000", "2024", "CO", "25k"),
    ("decex_cpor_cmsp", "2024", "CT", "50k"),
    ("decex_esacosaae", "2024", "CT", "50k"),
    ("aman_esa_2024_250k", "2024", "CT", "250k"),
    ("aman_esa_2024_100k_topo", "2024", "CT", "100k"),
    ("aman_esa_2024_100k_orto", "2024", "CO", "100k"),
    ("aman_esa_2024_50k_topo", "2024", "CT", "50k"),
    ("aman_esa_2024_50k_orto", "2024", "CO", "50k"),
    ("aman_esa_2024_25k_topo", "2024", "CT", "25k"),
    ("aman_esa_2024_25k_orto", "2024", "CO", "25k"),

    # 2023
    ("pddmt-2022-sub-meta-b1-carta-topo-100k-rs", "2023", "CT", "100k"),
    ("pddmt-2022-sub-meta-b2-carta-topo-100k-pr", "2023", "CT", "100k"),
    ("pddmt-2023-sub-meta-a1-carta-orto-50k-rs", "2023", "CO", "50k"),
    ("pddmt-2023-sub-meta-a2-carta-orto-25k-rs", "2023", "CO", "25k"),
    ("pddmt-2023-sub-meta-b1-carta-orto-50k-sc", "2023", "CO", "50k"),
    ("pddmt-2023-sub-meta-b2-carta-topo-50k-rs", "2023", "CT", "50k"),
    ("mapintfter-2023-sub-meta-a2-carta-topo-25k-alegrete", "2023", "CT", "25k"),
    ("mapintfter-2023-sub-meta-a3-carta-topo-25k-stnalivramento", "2023", "CT", "25k"),
    ("mapintfter-2023-sub-meta-a1-carta-topo-25k-curitiba", "2023", "CT", "25k"),
    ("mapintfter-2023-sub-meta-a4-carta-topo-25k-quarai", "2023", "CT", "25k"),

    # 2022
    ("pddmt-2022-sub-meta-a-carta-orto-50k-pr", "2022", "CO", "50k"),
    ("mapintfter-2022-sub-meta-a1-carta-topo-25k-florianopolis", "2022", "CT", "25k"),
    ("mapintfter-2022-sub-meta-a2-carta-topo-25k-uruguaiana", "2022", "CT", "25k"),
    ("mapintfter-2022-sub-meta-b-carta-topo-50k-rr", "2022", "CT", "50k"),
    ("mapintfter-2022-sub-meta-c-carta-topo-100k-rs-sc", "2022", "CT", "100k"),
    ("conv-rs-carta-topo-50k-rs", "2022", "CT", "50k"),

    # 2021
    ("conv-rs-carta-topo-25k-rs", "2021", "CT", "25k"),
    ("sisfron-17rcmec-carta-topo-50k-pr", "2021", "CT", "50k"),
    ("sisfron-17rcmec-carta-topo-100k-pr", "2021", "CT", "100k"),
    ("uraricoera", "2021", "CT", "50k"),

    # 2020
    ("sisfron-17rcmec-carta-topo-25k-pr", "2020", "CT", "25k"),

    # 2019
    ("santa-catarina-50k", "2019", "CT", "50k"),

    # 2018
    ("santa-catarina-25k", "2018", "CT", "25k"),
    ("campo-instrucao-25k", "2018", "CT", "25k"),
    ("campo-instrucao-50k", "2018", "CT", "50k"),
    ("radiografia-am", "2018", "CT", "50k"),
]


def load_geojson(filepath):
    """Carrega um arquivo GeoJSON."""
    try:
        with open(filepath, 'r', encoding='utf-8') as f:
            return json.load(f)
    except FileNotFoundError:
        print(f"  [AVISO] Arquivo não encontrado: {filepath}")
        return None
    except json.JSONDecodeError as e:
        print(f"  [ERRO] Erro ao decodificar JSON: {filepath} - {e}")
        return None


def save_geojson(data, filepath):
    """Salva um arquivo GeoJSON."""
    with open(filepath, 'w', encoding='utf-8') as f:
        json.dump(data, f, ensure_ascii=False, indent=2)


def merge_features(geojson_list):
    """Mescla features de múltiplos GeoJSON em um único."""
    merged = {
        "type": "FeatureCollection",
        "features": []
    }

    seen_ids = set()
    for geojson in geojson_list:
        if geojson is None:
            continue
        for feature in geojson.get("features", []):
            # Usa identificadorMI como chave única para evitar duplicatas
            mi = feature.get("properties", {}).get("identificadorMI")
            if mi and mi not in seen_ids:
                seen_ids.add(mi)
                merged["features"].append(feature)
            elif not mi:
                merged["features"].append(feature)

    return merged


def get_tipo_nome(tipo):
    """Retorna o nome completo do tipo."""
    return "Carta Topográfica" if tipo == "CT" else "Carta Ortoimagem"


def get_escala_nome(escala):
    """Retorna o nome formatado da escala."""
    mapping = {
        "25k": "1:25.000",
        "50k": "1:50.000",
        "100k": "1:100.000",
        "250k": "1:250.000"
    }
    return mapping.get(escala, escala)


def generate_setup_js(grouped_data, anos):
    """Gera o conteúdo do novo setup.js."""

    # Cabeçalho com constantes existentes
    setup_content = '''
const SUBTITLE_STATES = [
    {
        id: 1,
        name: 'Não mapeado',
        color: 'rgba(255,255,255,0.0)'
    },
    {
        id: 2,
        name: 'Concluído',
        color: 'rgba(145,207,96,0.5)'
    },
    {
        id: 3,
        name: 'Múltiplas edições',
        color: 'rgba(102,178,255,0.5)'
    }
]

const SUBTITLE_STATES_BORDER = [
    {
        id: 1,
        name: 'Não mapeado',
        color: '#121211',
        width: 0.5,
        offset: 1
    },
    {
        id: 2,
        name: 'Concluído',
        color: 'rgba(145,207,96,1)',
        width: 5,
        offset: 3.5
    },
    {
        id: 3,
        name: 'Múltiplas edições',
        color: 'rgba(102,178,255,1)',
        width: 5,
        offset: 3.5
    }
]

const INIT_ZOOM = {
    center: [-53.99235736195203, -27.426307807866984],
    zoom: 4.83
}

var PROJECTS = {
'''

    # Adicionar projetos de Situação Geral (mantidos como estão)
    setup_content += '''    'situacao-geral-25k': {
        title: 'Situação Geral 1:25.000',
        group: "Situação Geral",
        description: `Apresenta a situação dos produtos existentes na área de responsabilidade do 1º CGEO, na escala 1:25.000. Ao aproximar é possível ver o ano de mapeamento da carta. Se a carta possuir mais de uma edição, ao clicar serão mostrados os anos que a carta possui edição.`,
        lotes: [
            {
                name: 'situacao-geral-ct-25k',
                subtitle: 'Cartas 1:25.000',
                description: ``,
                legend: [1, 2, 3],
                styles: [
                    {
                        'id': 'situacao-geral-ct-25k-fill',
                        'source': 'situacao-geral-ct-25k',
                        'type': 'fill',
                        'layout': {},
                        'paint': {}
                    },
                    {
                        'id': 'situacao-geral-ct-25k-border',
                        'source': 'situacao-geral-ct-25k',
                        'type': 'line',
                        'layout': {},
                        'paint': {
                            'line-color': '#32a852',
                            'line-width': 0.5
                        }
                    },
                    {
                        'id': 'situacao-geral-ct-25k-text',
                        'source': 'situacao-geral-ct-25k',
                        "type": "symbol",
                        "minzoom": 8.5,
                        "maxzoom": 15,
                        'layout': {
                            'text-field': [
                                'concat',
                                'MI ',
                                ['get', 'identificadorMI'],
                                '\\n',
                                'INOM ',
                                ['get', 'identificadorINOM'],
                                '\\n',
                                [
                                    'case',
                                    ['>', ['length', ['get', 'edicoes_topo']], 0],
                                    ['at', 0, ['get', 'edicoes_topo']],
                                    ''
                                ]
                            ]
                        },
                        'paint': {}
                    }
                ]
            }
        ]
    },
    'situacao-geral-50k': {
        title: 'Situação Geral 1:50.000',
        group: "Situação Geral",
        description: `Apresenta a situação dos produtos existentes na área de responsabilidade do 1º CGEO, na escala 1:50.000.`,
        lotes: [
            {
                name: 'situacao-geral-ct-50k',
                subtitle: 'Cartas 1:50.000',
                description: ``,
                legend: [1, 2, 3],
                styles: [
                    {
                        'id': 'situacao-geral-ct-50k-fill',
                        'source': 'situacao-geral-ct-50k',
                        'type': 'fill',
                        'layout': {},
                        'paint': {}
                    },
                    {
                        'id': 'situacao-geral-ct-50k-border',
                        'source': 'situacao-geral-ct-50k',
                        'type': 'line',
                        'layout': {},
                        'paint': {
                            'line-color': '#050505',
                            'line-width': 0.5
                        }
                    },
                    {
                        'id': 'situacao-geral-ct-50k-text',
                        'source': 'situacao-geral-ct-50k',
                        "type": "symbol",
                        "minzoom": 8.5,
                        "maxzoom": 15,
                        'layout': {
                            'text-field': [
                                'concat',
                                'MI ',
                                ['get', 'identificadorMI'],
                                '\\n',
                                'INOM ',
                                ['get', 'identificadorINOM'],
                                '\\n',
                                [
                                    'case',
                                    ['>', ['length', ['get', 'edicoes_topo']], 0],
                                    ['at', 0, ['get', 'edicoes_topo']],
                                    ''
                                ]
                            ]
                        },
                        'paint': {}
                    }
                ]
            }
        ]
    },
    'situacao-geral-100k': {
        title: 'Situação Geral 1:100.000',
        group: "Situação Geral",
        description: `Apresenta a situação dos produtos existentes na área de responsabilidade do 1º CGEO, na escala 1:100.000.`,
        lotes: [
            {
                name: 'situacao-geral-ct-100k',
                subtitle: 'Cartas 1:100.000',
                description: ``,
                legend: [1, 2, 3],
                styles: [
                    {
                        'id': 'situacao-geral-ct-100k-fill',
                        'source': 'situacao-geral-ct-100k',
                        'type': 'fill',
                        'layout': {},
                        'paint': {}
                    },
                    {
                        'id': 'situacao-geral-ct-100k-border',
                        'source': 'situacao-geral-ct-100k',
                        'type': 'line',
                        'layout': {},
                        'paint': {
                            'line-color': '#050505',
                            'line-width': 0.5
                        }
                    },
                    {
                        'id': 'situacao-geral-ct-100k-text',
                        'source': 'situacao-geral-ct-100k',
                        "type": "symbol",
                        "minzoom": 8.5,
                        "maxzoom": 15,
                        'layout': {
                            'text-field': [
                                'concat',
                                'MI ',
                                ['get', 'identificadorMI'],
                                '\\n',
                                'INOM ',
                                ['get', 'identificadorINOM'],
                                '\\n',
                                [
                                    'case',
                                    ['>', ['length', ['get', 'edicoes_topo']], 0],
                                    ['at', 0, ['get', 'edicoes_topo']],
                                    ''
                                ]
                            ]
                        },
                        'paint': {}
                    }
                ]
            }
        ]
    },
    'situacao-geral-250k': {
        title: 'Situação Geral 1:250.000',
        group: "Situação Geral",
        description: `Apresenta a situação dos produtos existentes na área de responsabilidade do 1º CGEO, na escala 1:250.000.`,
        lotes: [
            {
                name: 'situacao-geral-ct-250k',
                subtitle: 'Cartas 1:250.000',
                description: ``,
                legend: [1, 2, 3],
                styles: [
                    {
                        'id': 'situacao-geral-ct-250k-fill',
                        'source': 'situacao-geral-ct-250k',
                        'type': 'fill',
                        'layout': {},
                        'paint': {}
                    },
                    {
                        'id': 'situacao-geral-ct-250k-border',
                        'source': 'situacao-geral-ct-250k',
                        'type': 'line',
                        'layout': {},
                        'paint': {
                            'line-color': '#050505',
                            'line-width': 0.5
                        }
                    },
                    {
                        'id': 'situacao-geral-ct-250k-text',
                        'source': 'situacao-geral-ct-250k',
                        "type": "symbol",
                        "minzoom": 6,
                        "maxzoom": 9.5,
                        'layout': {
                            'text-field': [
                                'concat',
                                'MIR ',
                                ['get', 'identificadorMI'],
                                '\\n',
                                'INOM ',
                                ['get', 'identificadorINOM'],
                                '\\n',
                                [
                                    'case',
                                    ['>', ['length', ['get', 'edicoes_topo']], 0],
                                    ['at', 0, ['get', 'edicoes_topo']],
                                    ''
                                ]
                            ]
                        },
                        'paint': {}
                    }
                ]
            }
        ]
    },
'''

    # Gerar projetos por ano (do mais recente para o mais antigo)
    for ano in sorted(anos, reverse=True):
        # Para cada tipo (CT primeiro, depois CO)
        for tipo in ["CT", "CO"]:
            tipo_nome = get_tipo_nome(tipo)
            tipo_id = "carta-topografica" if tipo == "CT" else "carta-ortoimagem"

            # Verificar se há dados para esse ano/tipo
            escalas_com_dados = []
            for escala in ["25k", "50k", "100k", "250k"]:
                key = (ano, tipo, escala)
                if key in grouped_data and grouped_data[key]["count"] > 0:
                    escalas_com_dados.append(escala)

            if not escalas_com_dados:
                continue

            project_id = f"{tipo_id}-{ano}"

            setup_content += f'''    '{project_id}': {{
        title: '{tipo_nome} {ano}',
        group: "Entregas",
        subgroup: "{ano}",
        description: 'Produtos de {tipo_nome} finalizados em {ano}.',
        lotes: [
'''

            # Adicionar lotes para cada escala
            for escala in escalas_com_dados:
                key = (ano, tipo, escala)
                escala_nome = get_escala_nome(escala)
                lote_name = f"{tipo.lower()}-{ano}-{escala}"
                count = grouped_data[key]["count"]

                setup_content += f'''            {{
                name: '{lote_name}',
                subtitle: '{escala_nome}',
                description: '{count} cartas na escala {escala_nome}',
                legend: [2],
                styles: [
                    {{
                        'id': '{lote_name}-fill',
                        'source': '{lote_name}',
                        'type': 'fill',
                        'layout': {{}},
                        'paint': {{
                            'fill-opacity': 0.9
                        }}
                    }},
                    {{
                        'id': '{lote_name}-border',
                        'source': '{lote_name}',
                        'type': 'line',
                        'layout': {{}},
                        'paint': {{
                            'line-color': '#050505',
                            'line-width': 0.5
                        }}
                    }},
                    {{
                        'id': '{lote_name}-text',
                        'source': '{lote_name}',
                        "type": "symbol",
                        "maxzoom": 10,
                        'layout': {{
                            'text-field': ['to-string', ['get', 'identificadorMI']]
                        }},
                        'paint': {{}}
                    }}
                ]
            }},
'''

            setup_content += '''        ]
    },
'''

    # Fechar o objeto PROJECTS
    setup_content = setup_content.rstrip(',\n') + '\n}\n'

    return setup_content


def verificar_arquivos_nao_utilizados(salvar_arquivo=True):
    """Verifica quais arquivos GeoJSON existem mas não estão mapeados."""
    # Listar todos os arquivos .geojson na pasta data
    arquivos_existentes = set()
    for arquivo in DATA_DIR.glob("*.geojson"):
        nome = arquivo.stem  # nome sem extensão
        arquivos_existentes.add(nome)

    # Listar arquivos que estão no mapeamento
    arquivos_mapeados = set(nome for nome, _, _, _ in LOTES)

    # Listar arquivos ignorados
    arquivos_ignorados_set = set(ARQUIVOS_IGNORADOS)

    # Encontrar arquivos não utilizados
    nao_utilizados = arquivos_existentes - arquivos_mapeados - arquivos_ignorados_set

    # Salvar relatório em arquivo
    if salvar_arquivo:
        relatorio_path = OUTPUT_DIR / "arquivos_nao_mapeados.txt"
        with open(relatorio_path, 'w', encoding='utf-8') as f:
            f.write("=" * 60 + "\n")
            f.write("RELATÓRIO DE ARQUIVOS GEOJSON\n")
            f.write("=" * 60 + "\n\n")

            f.write(f"Total de arquivos na pasta data/: {len(arquivos_existentes)}\n")
            f.write(f"Arquivos mapeados (LOTES): {len(arquivos_mapeados)}\n")
            f.write(f"Arquivos ignorados (ARQUIVOS_IGNORADOS): {len(arquivos_ignorados_set)}\n")
            f.write(f"Arquivos NÃO mapeados: {len(nao_utilizados)}\n\n")

            f.write("-" * 60 + "\n")
            f.write("ARQUIVOS NÃO MAPEADOS (precisam ser adicionados ou ignorados):\n")
            f.write("-" * 60 + "\n")
            if nao_utilizados:
                for arquivo in sorted(nao_utilizados):
                    f.write(f"  - {arquivo}.geojson\n")
            else:
                f.write("  (nenhum)\n")

            f.write("\n" + "-" * 60 + "\n")
            f.write("ARQUIVOS IGNORADOS:\n")
            f.write("-" * 60 + "\n")
            for arquivo in sorted(arquivos_ignorados_set):
                f.write(f"  - {arquivo}.geojson\n")

            f.write("\n" + "-" * 60 + "\n")
            f.write("ARQUIVOS MAPEADOS POR ANO/TIPO/ESCALA:\n")
            f.write("-" * 60 + "\n")
            # Agrupar por ano
            por_ano = {}
            for nome, ano, tipo, escala in LOTES:
                if ano not in por_ano:
                    por_ano[ano] = []
                por_ano[ano].append((nome, tipo, escala))

            for ano in sorted(por_ano.keys(), reverse=True):
                f.write(f"\n  {ano}:\n")
                for nome, tipo, escala in sorted(por_ano[ano], key=lambda x: (x[1], x[2], x[0])):
                    tipo_nome = "CT" if tipo == "CT" else "CO"
                    f.write(f"    [{tipo_nome} {escala}] {nome}.geojson\n")

        print(f"    -> Relatório salvo: arquivos_nao_mapeados.txt")

    return sorted(nao_utilizados)


def main():
    """Função principal."""
    print("=" * 60)
    print("Reorganização de Produtos Cartográficos")
    print("=" * 60)

    # Criar diretório de saída PRIMEIRO (necessário para salvar o relatório)
    OUTPUT_DIR.mkdir(exist_ok=True)

    # Verificar arquivos não utilizados e gerar relatório
    print("\n0. Verificando arquivos GeoJSON não mapeados...")
    nao_utilizados = verificar_arquivos_nao_utilizados(salvar_arquivo=True)
    if nao_utilizados:
        print("\n" + "!" * 60)
        print("ATENÇÃO: Os seguintes arquivos GeoJSON existem mas NÃO foram incluídos:")
        print("!" * 60)
        for arquivo in nao_utilizados:
            print(f"  - {arquivo}.geojson")
        print("\nAdicione esses arquivos à lista LOTES no script ou à lista ARQUIVOS_IGNORADOS.")
        print("!" * 60 + "\n")
    else:
        print("  Todos os arquivos GeoJSON estão mapeados ou ignorados.")

    # Agrupar lotes por ano/tipo/escala
    grouped = defaultdict(lambda: {"files": [], "count": 0})

    print("\n1. Agrupando lotes por ano/tipo/escala...")
    for nome, ano, tipo, escala in LOTES:
        key = (ano, tipo, escala)
        grouped[key]["files"].append(nome)

    # Carregar e mesclar GeoJSON
    print("\n2. Carregando e mesclando arquivos GeoJSON...")
    anos = set()

    for key, data in grouped.items():
        ano, tipo, escala = key
        anos.add(ano)

        print(f"\n  Processando: {tipo} {escala} de {ano}")

        geojson_list = []
        for nome in data["files"]:
            filepath = DATA_DIR / f"{nome}.geojson"
            print(f"    - {nome}.geojson", end="")
            geojson = load_geojson(filepath)
            if geojson:
                count = len(geojson.get("features", []))
                print(f" ({count} features)")
                geojson_list.append(geojson)
            else:
                print(" (não encontrado)")

        # Mesclar features
        merged = merge_features(geojson_list)
        data["count"] = len(merged["features"])

        if data["count"] > 0:
            # Salvar arquivo mesclado
            output_name = f"{tipo.lower()}-{ano}-{escala}.geojson"
            output_path = OUTPUT_DIR / output_name
            save_geojson(merged, output_path)
            print(f"    -> Salvo: {output_name} ({data['count']} features)")

    # Gerar novo setup.js
    print("\n3. Gerando novo setup.js...")
    setup_content = generate_setup_js(grouped, anos)
    setup_path = OUTPUT_DIR / "setup_reorganizado.js"
    with open(setup_path, 'w', encoding='utf-8') as f:
        f.write(setup_content)
    print(f"    -> Salvo: setup_reorganizado.js")

    # Resumo
    print("\n" + "=" * 60)
    print("RESUMO")
    print("=" * 60)

    print("\nArquivos gerados por ano:")
    for ano in sorted(anos, reverse=True):
        print(f"\n  {ano}:")
        for tipo in ["CT", "CO"]:
            for escala in ["25k", "50k", "100k", "250k"]:
                key = (ano, tipo, escala)
                if key in grouped and grouped[key]["count"] > 0:
                    tipo_nome = "Carta Topográfica" if tipo == "CT" else "Carta Ortoimagem"
                    print(f"    - {tipo_nome} {escala}: {grouped[key]['count']} cartas")

    print(f"\nArquivos salvos em: {OUTPUT_DIR}")
    print("\nPróximos passos:")
    print("  1. Revise os arquivos gerados em 'data_reorganizado/'")
    print("  2. Copie os GeoJSON para 'data/'")
    print("  3. Substitua 'js/setup.js' por 'setup_reorganizado.js'")


if __name__ == "__main__":
    main()
